# 图块自动化参数说明

- [图块自动化参数说明](#图块自动化参数说明)
  - [目标](#目标)
  - [使用](#使用)
    - [命令](#命令)
    - [命令参数](#命令参数)
    - [前置知识](#前置知识)
    - [自动化步骤](#自动化步骤)
    - [json 格式](#json-格式)

## 目标

图层自动化命令。

## 使用

### 命令

打开终端，输入如下指令：

```txt
    layerauto {map_file}
```

该指令读入地图路径，将转换结果自动输到原路径。

### 命令参数

```txt
    -o --output 输出到不同路径（建议，防止覆盖后无法悔改）。

    -v --verbose 显示运行信息

    --ignorewarning 发生warning时，会继续执行，而不会退出程序。

    -y --isyes 自动同意程序的一切(y/n)请求

    --language 后仅允许跟"ch"(中文)/"eg"(英文)。语言设置将会被储存，之后使用延续上一次的修改。

    -j --config 图层自动化设置的json文件。
```

### 前置知识

图层是如何存储信息并显示地图的呢？图层实际上是一个数字表格。每一个数字表示一个地块。这个数字被翻译成哪一个地块需要看该地图载入了哪些地块集。因此，绘制底图本质上来说是修改这一个数字表格，使得合适的位置写上合适的数字。地图中会出现多个图层(Ground, Items, Units等等)，这些图层各自都是数字表格。图层自动化就可以使用一些设置来对这些数字表格进行有规律的处理，从而减少绘制底图过程中的重复性工作。

然而，宾语层和图层的组织方式不同。每一个宾语都是一个独立的单位，这个宾语记载了它的上下左右边界、名称类型以及属性等，这些决定了这个宾语。有时候我们希望一个特定的宾语也可以对其位置的地形造成影响。因此，我们需要将宾语层"翻译"为正常的图层。哪些宾语可以被映射，怎么映射，映射为哪一个数字，也需要设置来决定。

现在，图层和宾语虚拟层(被映射为数字表格的宾语层)就可以执行图层自动化了。我们这里得到了若干相同大小的数字表格。我们希望做一些什么事情来自动改变图块呢？

```这不是一个宾语自动化系统，针对宾语虚拟层的改变不会影响宾语层，只能拿来做图层自动化的参数或者说标记。```

1. 映射:某些地层的地块满足某些条件时，将会对其他地层的地块造成影响。
2. 地形:
(1) 自动平铺/转角集。自动平铺可以改变地形，并且保证地形边缘保持自然。
(2) 河流,铁路,道路/边缘集。边缘集可以使得河流等地绘制方向保持正确自然。
3. 扩大:希望城市宾语对周围的地块都造成影响。

为了达成以上目标，这样一个算法被设计了出来。我们可以通过产生新的执行虚拟层(类似宾语虚拟层)，并在这个虚拟层上运算，并将这个虚拟层按照一定的规则映射到图层。如此，我们可以满足这些要求。

### 自动化步骤

1. 宾语层生成一个空的相同名字宾语虚拟层，名称符合正则表达式的宾语将在对应坐标赋值。(可以不执行)
2. 将会执行若干次，形成执行虚拟层。
(1) 首先根据要求将目前的层和虚拟层映射进新形成的执行虚拟层。
(2) 执行虚拟层将会执行运算指令。(可以不执行)
(3) 执行虚拟层映射赋值改变其他的层或虚拟层。(可以不执行)
(4) 重复执行(1),(2),(3)，直到结束。

### json 格式

```json
    {
        "rwmapauto_type": "layerauto", 
        "simplify": {}, 
        "objectre_to_layer": {}, 
        "exe": []
    }
```

json文件中有四项内容，第一项是默认的"rwmapauto_type": "layerauto"来确保是用于该命令的json文件。

第二项是"simplify"字典。键为简化的地块集名称，值为实际地块集名称(与地块集的名称一样)。之后就可以使用简化地块集名称表示这些地块集了。

```json
{
    "simplify": {
        "tile_T": "巴巴罗萨计划(N4版)地块byXs", 
        "tile_S": "巴巴罗萨计划(N4版)渐变海洋地块byXs", 
        "tile_ass": "辅助地块（1.2版）byXs"
    }
}
```

这样之后用"tile_T" 表示巴巴罗萨地块。

第三项是"objectre_to_layer"字典。该字典用于图层自动化步骤1。该字典可以为空，那么将不会进行宾语层映射。键为宾语层名称(需要映射的宾语层，一般仅有Triggers)，值为一个列表。列表内存储着字典。每一个字典表示了一种映射模式。其中字典内"re"表示当宾语的名称符合哪些正则表达式时，该宾语将会被映射。字典内的"map_type"表示映射模式。目前有两种模式："middle"表示在该宾语的中心点映射到虚拟层，"left-top"表示在该宾语的左上角映射到宾语虚拟层，默认为"left-top"(可选)。字典内的"gid"表示可以映射的值，应当为大于0的整数，因为层初始化均为0。列表内的映射模式会依次执行。

```json
{
    "objectre_to_layer": {
        "Triggers":[
            {
                "re": "^.*c\\..*$", 
                "map_type": "middle", 
                "gid": 1
            }
        ]
    }
}
```

第四层是"exe"列表。是图层自动化最核心的部分，是图层自动化步骤2的参数。列表内存储着若干次生成执行虚拟层参数的字典。

在图层自动化步骤2进行之前，我们通过宾语层映射得到了宾语虚拟层以及已有的图层。我们生成的执行虚拟层均是基于当前拥有的所有层。执行虚拟层生成后，下一步生成也可以使用之前执行虚拟层的数据。

下面是对生成执行虚拟层的字典的描述。"exe_name"对应了生成执行虚拟层的名称，类似于"Ground"等。"layer_to_exe" 是一个列表，内部存储了2.(1)步骤的信息，代表层对执行虚拟层的映射。"exe"是一个字典，内部存储了2.(2)步骤的信息，表示执行虚拟层的内部运算。"exe_to_layer"是一个字典，内部存储了2.(3)信息，表示执行虚拟层对层的映射。关于后三项的内容后面具体解释。

```json
{
    "exe": [
        {
            "exe_name": "city", 
            "layer_to_exe": [], 
            "exe": {"exe_type": "map"}, 
            "exe_to_layer": {}
        }
    ]
}
```

"layer_to_exe" 是一个列表。这个列表内存储的是一个长度为2的列表。列表内第一个元素是一个字典，表示哪些层符号哪些条件时进行映射。第二个元素是一个正整数，表示映射的数字。对于第一个字典来说，键为层的名称，值为满足的条件。当字典内所有条件均满足时，执行虚拟层将会被映射一个数字。将所有映射模式从前往后执行，从而得到映射的执行虚拟层。这个满足的条件有很多格式。仅有一个数字是用于宾语虚拟层和执行虚拟层的条件。如果是一个字典，那么字典的键是地块集的名称(可被simplify简化)，值有两种模式。值是一个长度为2的列表。列表内每一个元素如果都是整数，则代表是这个地块集内该坐标的地块。列表内每一个元素如果都是长度为2的列表，那么就是一个矩阵，范围是第一个坐标到第二个坐标框起来的区域。坐标从0开始，从上到下是第一个元素，从左到右是第二个元素。数字或字典可以被列表整合，表示该地层的该地块满足的条件范围。

```json
{
    "exe": [
        {
            "layer_to_exe": [
                [{"Triggers": 1}, 1]
                [{"Ground": [{"tile_T": [5, 12]}, {"tile_S": [[1, 0], [6, 11]]}]}, 1]
            ]
        }
    ]
}
```

意思是，Triggers宾语虚拟层为1或者Ground层为"tile_T"地块集(5, 12)或"tile_S"地块集(1, 0)到(6, 11)的矩形时映射执行层为1。

"exe" 是一个字典。"exe_type"是执行虚拟层操作的类型。目前共有三种类型。

"map"将不会进行操作。

```json
{
    "exe": [
        {
            "exe": {
                "exe_type": "map", 
                "exe_operation": {}
            }
        }
    ]
}
```

"expansion": "exe_operation"是一个字典，是一个数字字符串映射到3×3的数字列表的字典。将会按照键从小到大顺序执行这一"扩展"操作，原地执行。如果检测到执行虚拟层某一个数字与键相同，将会把其以及附近3×3范围进行赋值，按照这一数字列表进行赋值。如果执行虚拟层赋值区域不是0(非空)或者数字列表值是-1(不进行赋值)，那么赋值失败，否则赋值成功。

```json
{
    "exe": [
        {
            "exe": {
                "exe_type": "expansion", 
                "exe_operation": {
                    "1": [
                        [-1,  2, -1], 
                        [ 2, -1,  2], 
                        [-1,  2, -1]
                    ], 
                    "2": [
                        [-1,  3, -1], 
                        [ 3, -1,  3], 
                        [-1,  3, -1]
                    ], 
                    "3": [
                        [-1,  4, -1], 
                        [ 4, -1,  4], 
                        [-1,  4, -1]
                    ]
                }
            }, 
        }
    ]
}
```

这代表着，一旦执行虚拟层有1。那么其将会向外扩展为

```txt
      4
    4 3 4
  4 3 2 3 4
4 3 2 1 2 3 4
  4 3 2 3 4
    4 3 4
      4
```

"terrain": "exe_operation"是一个字典，是一个数字字符串映射到3×3的数字列表的字典。将会对符合所有3×3列表模式的位置赋值该数字(键)，新生成数字表格赋值。"-1"表示不在意这一位置是什么数字。否则要求匹配。

```json
{
    "exe": [
        {
            "exe": {
                "exe_type": "terrain", 
                "exe_operation": {
                    "11111": [
                        [ -1,  1,  -1], 
                        [ 1,  1,  1], 
                        [ -1,  1,  -1]
                    ], 
                    "11110": [
                        [ -1,  1,  -1], 
                        [ 1,  1,  1], 
                        [ -1,  0,  -1]
                    ], 
                    "11101": [
                        [ -1,  1,  -1], 
                        [ 1,  1,  0], 
                        [ -1,  1,  -1]
                    ], 
                    "11100": [
                        [ -1,  1,  -1], 
                        [ 1,  1,  0], 
                        [ -1,  0,  -1]
                    ], 
                    "11011": [
                        [ -1,  1,  -1], 
                        [ 0,  1,  1], 
                        [ -1,  1,  -1]
                    ], 
                    "11010": [
                        [ -1,  1,  -1], 
                        [ 0,  1,  1], 
                        [ -1,  0,  -1]
                    ], 
                    "11001": [
                        [ -1,  1,  -1], 
                        [ 0,  1,  0], 
                        [ -1,  1,  -1]
                    ], 
                    "11000": [
                        [ -1,  1,  -1], 
                        [ 0,  1,  0], 
                        [ -1,  0,  -1]
                    ], 
                    "10111": [
                        [ -1,  0,  -1], 
                        [ 1,  1,  1], 
                        [ -1,  1,  -1]
                    ], 
                    "10110": [
                        [ -1,  0,  -1], 
                        [ 1,  1,  1], 
                        [ -1,  0,  -1]
                    ], 
                    "10101": [
                        [ -1,  0,  -1], 
                        [ 1,  1,  0], 
                        [ -1,  1,  -1]
                    ], 
                    "10100": [
                        [ -1,  0,  -1], 
                        [ 1,  1,  0], 
                        [ -1,  0,  -1]
                    ], 
                    "10011": [
                        [ -1,  0,  -1], 
                        [ 0,  1,  1], 
                        [ -1,  1,  -1]
                    ], 
                    "10010": [
                        [ -1,  0,  -1], 
                        [ 0,  1,  1], 
                        [ -1,  0,  -1]
                    ], 
                    "10001": [
                        [ -1,  0,  -1], 
                        [ 0,  1,  0], 
                        [ -1,  1,  -1]
                    ], 
                    "10000": [
                        [ -1,  0,  -1], 
                        [ 0,  1,  0], 
                        [ -1,  0,  -1]
                    ]
                }
            } 
        }
    ]
}
```
